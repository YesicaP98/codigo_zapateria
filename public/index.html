<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ZapaterÃ­a Aether</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .product-card {
      transition: transform 0.3s;
      margin-bottom: 20px;
      border: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }
    .auth-element, .unauth-element {
      transition: all 0.3s;
    }
    .price {
      color: #28a745;
      font-weight: bold;
      font-size: 1.2em;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Barra de navegaciÃ³n actualizada con autenticaciÃ³n -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">
        <strong>ðŸ‘Ÿ ZapaterÃ­a Aether</strong>
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- Elementos para usuarios NO autenticados -->
          <li class="nav-item unauth-element">
            <a class="nav-link" href="login.html">Iniciar SesiÃ³n</a>
          </li>
          <li class="nav-item unauth-element">
            <a class="nav-link" href="register.html">Registrarse</a>
          </li>
          
          <!-- Elementos para usuarios autenticados -->
          <li class="nav-item auth-element d-none">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                ðŸ‘¤ <span class="user-name">Usuario</span>
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">Mi Perfil</a></li>
                <li><a class="dropdown-item" href="#">Mis Pedidos</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="logoutBtn">Cerrar SesiÃ³n</a></li>
              </ul>
            </div>
          </li>
          
          <!-- Carrito (siempre visible) -->
          <li class="nav-item">
            <a class="nav-link" href="cart.html">
              ðŸ›’ Carrito <span id="cart-count" class="badge bg-warning text-dark ms-1">0</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <header class="py-5 text-center bg-white border-bottom">
    <div class="container">
      <h1 class="display-5 fw-bold">Tu nueva tienda de zapatos</h1>
      <p class="lead text-muted">Bootstrap + Express (TypeScript). Productos de ejemplo y carrito por sesiÃ³n.</p>
      
      <!-- Mensaje de bienvenida para usuarios autenticados -->
      <div class="auth-element d-none mt-3">
        <div class="alert alert-success d-inline-block">
          Â¡Bienvenido, <span class="user-name fw-bold">Usuario</span>!
        </div>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <div id="product-list" class="row g-4">
      <!-- Los productos se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
    </div>
  </main>

  <footer class="py-5 bg-dark text-light">
    <div class="container text-center">
      <p class="mb-0">&copy; <span id="year"></span> ZapaterÃ­a Aether</p>
    </div>
  </footer>

  <!-- Alertas -->
  <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

  <!-- Scripts -->
  <script src="js/auth.js"></script>
  <script>
    // FunciÃ³n para mostrar alertas
    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      alertContainer.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Cargar productos dinÃ¡micamente
    async function loadProducts() {
      try {
        const response = await fetch('/api/products');
        const data = await response.json();
        
        if (data.success) {
          displayProducts(data.products);
        } else {
          throw new Error('Error en la API');
        }
      } catch (error) {
        console.error('Error cargando productos:', error);
        // Mostrar productos de ejemplo si falla la API
        displayProducts(getSampleProducts());
        showAlert('Usando datos de ejemplo', 'info');
      }
    }

    function displayProducts(products) {
      const container = document.getElementById('product-list');
      container.innerHTML = '';
      
      products.forEach(product => {
        const productCard = `
          <div class="col-md-4">
            <div class="card product-card h-100">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${product.name}</h5>
                <p class="card-text flex-grow-1">${product.description}</p>
                <p class="card-text price">$${(product.price / 100).toLocaleString('es-ES', {minimumFractionDigits: 0})}</p>
                <button class="btn btn-primary add-to-cart mt-auto" data-product-id="${product.id}">
                  Agregar al Carrito
                </button>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += productCard;
      });

      // Agregar event listeners a los botones
      document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
          const productId = this.getAttribute('data-product-id');
          addToCart(productId);
        });
      });
    }

    function getSampleProducts() {
      return [
        {
          id: 1,
          name: "Runner Azul",
          description: "Zapatilla ligera para correr, malla transpirable.",
          price: 19999900
        },
        {
          id: 2,
          name: "Classic Rojo", 
          description: "ClÃ¡sico urbano para uso diario.",
          price: 14999900
        },
        {
          id: 3,
          name: "Eco Verde",
          description: "Materiales reciclados, cÃ³modo y resistente.",
          price: 17999900
        }
      ];
    }

    async function addToCart(productId) {
      if (!authService.isAuthenticated()) {
        showAlert('Debes iniciar sesiÃ³n para agregar productos al carrito', 'warning');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
        return;
      }

      try {
        const response = await fetch('/api/cart/add', {
          method: 'POST',
          headers: authService.getAuthHeaders(),
          body: JSON.stringify({ productId: parseInt(productId), quantity: 1 })
        });

        const data = await response.json();
        
        if (data.success) {
          showAlert('âœ… Producto agregado al carrito');
          updateCartCount();
        } else {
          showAlert('Error: ' + data.message, 'danger');
        }
      } catch (error) {
        showAlert('Error de conexiÃ³n', 'danger');
      }
    }

    function updateCartCount() {
      // Simular actualizaciÃ³n del contador del carrito
      const cartCount = document.getElementById('cart-count');
      const currentCount = parseInt(cartCount.textContent) || 0;
      cartCount.textContent = currentCount + 1;
    }

    // Configurar logout
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          if (confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) {
            authService.logout();
            showAlert('SesiÃ³n cerrada correctamente', 'info');
          }
        });
      }

      // Cargar productos cuando la pÃ¡gina estÃ© lista
      loadProducts();
      
      // Actualizar aÃ±o
      document.getElementById('year').textContent = new Date().getFullYear();
    });

    // Escuchar cambios de autenticaciÃ³n
    setInterval(() => {
      authService.updateUI();
    }, 1000);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>